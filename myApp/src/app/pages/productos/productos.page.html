<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Productos</ion-title>
  </ion-toolbar>
</ion-header>

<!-- Lista de productos -->
<ion-content [fullscreen]="true" class="ion-padding">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Productos</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-list>
    @for (producto of visibleProductos; track producto.id; let i = $index) {
      <ion-item-sliding #slidingItem>
        <ion-item>
          <ion-label>
            <h2>{{ producto.nombre }}</h2>
            <p>Precio: S/.{{ producto.precio }}</p>
          </ion-label>
          <ion-note slot="end">#{{ producto.id }}</ion-note>
        </ion-item>

        <!-- Opciones al deslizar -->
        <ion-item-options side="end">
          <ion-item-option color="primary" (click)="openEditProduct(producto, slidingItem)">
            <ion-icon slot="icon-only" name="create" size="small"></ion-icon>
          </ion-item-option>
          <ion-item-option color="danger" (click)="deleteProduct(producto, slidingItem)">
            <ion-icon slot="icon-only" name="trash" size="small"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    }
    
  </ion-list>

  <!-- Infinite Scroll -->
  <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más productos...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <!-- Botón flotante para agregar -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openNewProduct()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Modal para crear/editar producto -->
  <ion-modal [isOpen]="showModal" (didDismiss)="showModal=false">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ editingProduct ? 'Editar' : 'Nuevo' }} Producto</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-card>
          <ion-card-content>
            <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
              <ion-item>
                <ion-label position="floating">Nombre</ion-label>
                <ion-input formControlName="nombre"></ion-input>
              </ion-item>
              @if (isInvalid('nombre')) {
                <ion-text color="danger">
                  @for (msg of validation_messages.nombre; track msg; let i = $index) {
                    @if (hasError('nombre', msg.type )) {
                      <small>{{ msg.message }}</small>
                    }
                  }
                </ion-text>
              }

              <ion-item>
                <ion-label position="floating">Descripción</ion-label>
                <ion-textarea formControlName="descripcion" auto-grow="true"></ion-textarea>
              </ion-item>
              @if (isInvalid('descripcion')) {
                <ion-text color="danger">
                  @for (msg of validation_messages.descripcion; track msg; let i = $index) {
                    @if (hasError('descripcion', msg.type )) {
                      <small>{{ msg.message }}</small>
                    }
                  }
                </ion-text>
              }

              <ion-item>
                <ion-label position="floating">Precio</ion-label>
                <ion-input type="number" formControlName="precio"></ion-input>
              </ion-item>
              @if (isInvalid('precio')) {
                <ion-text color="danger">
                  @for (msg of validation_messages.precio; track msg; let i = $index) {
                    @if (hasError('precio', msg.type )) {
                      <small>{{ msg.message }}</small>
                    }
                  }
                </ion-text>
              }

              <ion-item>
                <ion-label position="floating">Stock</ion-label>
                <ion-input type="number" formControlName="stock"></ion-input>
              </ion-item>
              @if (isInvalid('stock')) {
                <ion-text color="danger">
                  @for (msg of validation_messages.stock; track msg; let i = $index) {
                    @if (hasError('stock', msg.type )) {
                      <small>{{ msg.message }}</small>
                    }
                  }
                </ion-text>
              }

              <ion-button expand="block" type="submit" [disabled]="productForm.invalid">Guardar</ion-button>
              <ion-button expand="block" color="medium" (click)="showModal=false">Cancelar</ion-button>
            </form>
          </ion-card-content>
        </ion-card>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
